## Firmware README
The core code (HAL, FreeRTOS) was generated by [CubeMX](https://www.st.com/en/development-tools/stm32cubemx.html).  This is a piece of software from STM that generates all the boilerplate to get started with your STM32 microcontroller!  The code is already generated and in the repository; but I highly recommend using CubeMX if you need to change the auto-generated portions of the code.

### Windows Setup
Doing any sort of development with GNU tools on Windows is a pain.  I highly recommend dual booting Linux, running a virtual machine, or at the very least utilizing [Ubuntu on Windows](https://tutorials.ubuntu.com/tutorial/tutorial-ubuntu-on-windows).

### General Setup

Install packages
```
sudo apt install gcc-arm-none-eabi
sudo apt install gdb-arm-none-eabi
sudo apt install openocd
```

GDB for ARM may be covered by GDB multiarch for newer Ubuntu installs.  See [here](https://askubuntu.com/questions/1031103/how-to-install-gdb-arm-none-eabi-on-ubuntu-18-04).

### Building
CubeMX generates a tidy makefile for building the project.  There are other options that can tie into IDE's, but make is the only open source option.

### Call Make
Simply navigate into this directory and call make!

```
cd AmbientSensor_Code
make
```

The output will be available under `AmbientSensor_Code/build`.

### Programming and Debugging
The [ST-LINK/V2](https://www.st.com/en/development-tools/st-link-v2.html) is a cheap programmer and debugger for STM32 microcontrollers.

To use this with GDB I used [OpenOCD](http://openocd.org/), this exposes the USB debugger as a server that GDB can connect to.

On Linux the command to connect to the debugger looks like this
```
sudo openocd -f interface/stlink-v2.cfg -f target/stm32f0x.cfg
```

The OpenOCD server should then output something similar to:
```
Open On-Chip Debugger 0.10.0
Licensed under GNU GPL v2
For bug reports, read http://openocd.org/doc/doxygen/bugs.html
Info : auto-selecting first available session transport "hla_swd". To override use 'transport select <transport>'.
Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD
adapter speed: 1000 kHz
adapter_nsrst_delay: 100
none separate
Info : Listening on port 6666 for tcl connections
Info : Listening on port 4444 for telnet connections
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : Unable to match requested speed 1000 kHz, using 950 kHz
Info : clock speed 950 kHz
Info : STLINK v2 JTAG v28 API v2 SWIM v17 VID 0x0483 PID 0x374B
Info : using stlink api v2
Info : Target voltage: 3.260766
Info : stm32f0x.cpu: hardware has 4 breakpoints, 2 watchpoints
Info : Listening on port 3333 for gdb connections
```

Open GDB with this command:
```
arm-none-eabi-gdb build/AmbientSensor.elf
```

Then in the GDB interface you can connect to OpenOCD, reset the target and load the firmware.
```
(gdb) target remote localhost:3333
(gdb) monitor reset init
(gdb) monitor halt
(gdb) load
(gdb) c
```
